{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<div id="viewer" class="container" style="min-height: 70vh;">
  <div class="row" style="margin-top:40px;">
    <div class="col-lg-2">
      <template v-if="availableClasses">
        <ul class="list-group">
          <li class="list-group-item mainBackDark text-light text-center">
            Schemas
          </li>
          <li class="list-group-item">
            <select @change='handleChange' class="custom-select mr-sm-2" id="inlineFormCustomSelect">
              <option selected>Filter by...</option>
              <option v-for="letter in alphabet" :value="letter" v-text="letter"></option>
            </select>
          </li>
          <li class="list-group-item text-light mainBackDark twoEM text-center" v-if='filter' v-text='filter'>

          </li>
          <li class="list-group-item" v-if='filter'>
            <!-- <a :href="'/viewer/'+item" v-text='item' v-bind:class="{'active': query === item}"></a> -->
            <!-- <a href="#" @click='handleFilter(item)' v-text='item' v-bind:class="{'active': query === item}"></a> -->
            <select @change='handleFilter' class="custom-select mr-sm-2" id="inlineFormCustomSelect">
              <option selected v-text='"Choose..."'></option>
              <option v-for="(item,i) in filterResults" :value="item['rdfs:label']" v-text="item['rdfs:label']"></option>
            </select>
          </li>
        </ul>
      </template>
    </div>
    <div class="col-sm-10">
      <div v-if="noResults" class="text-center jumbotron" style="margin-top:40px;">
        <h2 class="text-muted">No Results For That Item</h2>
        <p class="text-muted">
          Item my be out of scope or non-existent in the document
        </p>
      </div>
      <div class="jumbotron" v-if='schemaClass'>
        <h1 class="fourEM mainTextDark" v-if='schemaClass' v-text='schemaClass'></h1>
        <template v-if="subclass && schemaClass">
          <span style="font-size: 1.2em;" v-for="item in lineageArray">
            <!-- <a :href="'/viewer/'+subclass" class="mainTextLight font-weight-bold" v-text="subclass"></a>
            >
            <a :href="'/viewer/'+schemaClass" class="mainTextDark font-weight-bold" v-text="schemaClass"></a> -->
            <a class="mainTextLight font-weight-bold" :href="'/viewer/'+item['@id'].slice(7)" v-text='item["@id"].slice(7)'></a>
            >
          </span>
          <a style="font-size: 1.2em;" :href="'/viewer/'+schemaClass" class="mainTextDark font-weight-bold" v-text="schemaClass"></a>
        </template>
        <template v-if="schemaClass">
          <p v-html="classInfo['rdfs:comment']"></p>
        </template>
      </div>
      <h1 class="fourEM mainTextDark" v-if='property' v-text='property'></h1>
      <table class="table table-responsive" v-if="properties.length" style="margin-bottom: 40px">
      <thead class="mainBackDark text-light">
        <tr>
          <th scope="col">Property</th>
          <th scope="col">Expected Type</th>
          <th scope="col">Description</th>
        </tr>
      </thead>
      <tbody v-for="(item,i) in properties">
        <tr >
          <td>
            <a class="font-weight-bold" :href='"/viewer/"+getTitle(item)' v-html=getTitle(item)></a></td>
          <td>
            <a style="display: block;" v-for="(type,i) in getType(item)" :href="'/viewer/'+type" v-html='type'></a>
          </td>
          <td v-html=getDescription(item)></td>
        </tr>
      </tbody>
    </table>
    <template v-if="subclass">
      <h1 class="fourEM mainTextLight" v-text='subclass'></h1>
      <table class="table table-responsive" style="margin-bottom: 40px">
      <thead class="mainBackLight text-light">
        <tr>
          <th scope="col">Property</th>
          <th scope="col">Expected Type</th>
          <th scope="col">Description</th>
        </tr>
      </thead>
      <tbody v-for="(item,i) in parentProperties">
        <tr >
          <td>
            <a class="font-weight-bold" :href='"/viewer/"+getTitle(item)' v-html=getTitle(item)></a></td>
          <td>
            <a style="display: block;" v-for="(type,i) in getType(item)" :href="'/viewer/'+type" v-html='type'></a>
          </td>
          <td v-html=getDescription(item)></td>
        </tr>
      </tbody>
    </template>
    <template v-if='property'>
      <ul class="list-group" style="max-width: 50vw;">
        <li class="list-group-item bg-dark text-light">
          Used on these types
        </li>
        <li v-if="!propertyInfo['schema:domainIncludes']['@id']" class="list-group-item" v-for="(item,i) in propertyInfo['schema:domainIncludes']">
          <a :href="'/viewer/'+item['@id'].slice(7)" v-text="item['@id'].slice(7)"></a>
        </li>
        <li v-else class="list-group-item" >
          <a :href="'/viewer/'+propertyInfo['schema:domainIncludes']['@id']" v-text="propertyInfo['schema:domainIncludes']['@id'].slice(7)"></a>
        </li>
      </ul>
    </template>
    </div>
  </div>
</div>

{% endblock %}
{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/1.0.0/jsonld.min.js"></script> -->
<script src="/static/js/lodash.js"></script>
<script src="/static/js/networkx.js"></script>
<script>
var app = new Vue({
      el: '#viewer',
			data: function(){
				return {
          alphabet : ['ALL','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'],
          filter:'',
          dataSetURL : 'https://raw.githubusercontent.com/data2health/schemas/master/Dataset/Dataset.jsonld',
          graph: [],
          query:'',
          schemaClass:'',
          properties:[],
          parentProperties: [],
          property:'',
          propertyInfo:{},
          classes:[],
          noResults: false,
          subclass: '',
          classInfo:{},
          availableClasses:[],
          filterResults:[],
          //lineage
          lineageArray:[]
				}
			},
			methods:{
        getClassLineage(classInfo){
          let subclass ='';
          this.getAvailableClasses();
          if (classInfo.hasOwnProperty("rdfs:subClassOf") && _.isObject(classInfo["rdfs:subClassOf"])) {
            subclass = classInfo["rdfs:subClassOf"]['@id'];
            for (var i = 0; i < this.availableClasses.length; i++) {
              if (this.availableClasses[i]['@id'] === subclass) {
                this.lineageArray.unshift(this.availableClasses[i])
                this.getClassLineage(this.availableClasses[i])
              }
            }
          }

        },
        shapeData(data){

        },
        handleFilter(e){
          if (e.target.value !== 'Choose...') {
            // this.query = e.target.value.toLowerCase();
            // this.determinePath();
            window.location.href = "/viewer/"+e.target.value;
          }
        },
        determinePath(){
          if (this.getClass()) {
            console.log('PATH: CLASS')
            this.property='';
            this.getClassProperties()
          }else if (!this.getClass()){
            console.log('PATH: PROPERTY')
            this.getPropertyInfo()
          }
          if(!this.properties.length){
            // this.noResults = true;
          }
        },
        getTitle: function(data){
          if (data.hasOwnProperty('rdfs:label')) {
            if (_.isObject(data['rdfs:label'])) {
              if (data['rdfs:label'].hasOwnProperty('@value')) {
                return data['rdfs:label']['@value']
              }else{
                return data['rdfs:label'];
              }
            }else if (_.isString(data['rdfs:label'])) {
              return data["rdfs:label"];
            }
          }else{
            return 'no property name available'
          }
        },
        getType: function(data){
          let types=[];
          if (data.hasOwnProperty("schema:rangeIncludes")) {
            if (_.isArray(data["schema:rangeIncludes"])) {
              for (var i = 0; i < data['schema:rangeIncludes'].length; i++) {
                types.push(data['schema:rangeIncludes'][i]['@id'].slice(7));
              }
            }else if(_.isObject(data["schema:rangeIncludes"])){
              types.push(data['schema:rangeIncludes']['@id'].slice(7));
            }
          }
          return types;
        },
        getDescription: function(data){
          if (data.hasOwnProperty("rdfs:comment")) {
            return data["rdfs:comment"];
          }else{
            return 'no description available'
          }
        },
        reqFile: function(){
          axios.get('/static/misc/schema.jsonld').then(res=>{
            this.graph = res.data['@graph']
            this.determinePath()
            this.getAvailableClasses()
          }).catch(err=>{
            throw err;
          })
        },
        getClassProperties(){
          this.properties = [];
            for (var i = 0; i < this.graph.length; i++) {
              if (this.graph[i].hasOwnProperty('schema:domainIncludes') && this.graph[i]["@type"] === "rdf:Property") {
                this.extractPropertyInfo(this.graph[i]);
              }
            }
            this.getParentProperties();
        },
        getParentProperties(){
          this.parentProperties = [];
          if (this.subclass) {
            for (var i = 0; i < this.graph.length; i++) {
              if (this.graph[i].hasOwnProperty('schema:domainIncludes') && this.graph[i]["@type"] === "rdf:Property") {
                this.extractParentPropertyInfo(this.graph[i])
              }
            }
          }
        },
        extractPropertyInfo(data){
          if ( _.isArray(data['schema:domainIncludes']) ) {
            for (var i = 0; i < data['schema:domainIncludes'].length; i++) {
              if (data["schema:domainIncludes"][i]['@id'].toLowerCase() === 'schema:'+this.query || data["schema:domainIncludes"][i]['@id'].toLowerCase() === this.query) {
                this.properties.push(data);
              }
            }
          }else if( _.isObject(data['schema:domainIncludes']) ){
            if (data["schema:domainIncludes"]['@id'].toLowerCase() === 'schema:'+this.query || data["schema:domainIncludes"]['@id'].toLowerCase() === this.query ) {
              this.properties.push(data);
            }
          }
          this.properties = _.sortBy(this.properties, [user => user['rdfs:label']], ['asc']);
        },
        extractParentPropertyInfo(data){
          if ( _.isArray(data['schema:domainIncludes']) ) {
            for (var i = 0; i < data['schema:domainIncludes'].length; i++) {
              if (data["schema:domainIncludes"][i]['@id'].toLowerCase() === 'schema:'+this.subclass.toLowerCase() || data["schema:domainIncludes"][i]['@id'].toLowerCase() === this.subclass.toLowerCase()) {
                this.parentProperties.push(data);
              }
            }
          }else if( _.isObject(data['schema:domainIncludes']) ){
            if (data["schema:domainIncludes"]['@id'].toLowerCase() === 'schema:'+this.subclass.toLowerCase() || data["schema:domainIncludes"]['@id'].toLowerCase() === this.subclass.toLowerCase() ) {
              this.parentProperties.push(data);
            }
          }
          this.parentProperties = _.sortBy(this.parentProperties, [user => user['rdfs:label']], ['asc']);
        },
        getClass(){
          let results = [];
          for (var i = 0; i < this.graph.length; i++) {
            if (this.graph[i].hasOwnProperty('@type') && this.graph[i]['@type'] === "rdfs:Class" && this.graph[i]["rdfs:label"].toLowerCase() === this.query) {
              this.schemaClass = this.graph[i]["rdfs:label"];
              this.classInfo= this.graph[i];
              this.getClassLineage(this.classInfo)
              this.getSubclass(this.graph[i]);
            }
          }
          if (this.schemaClass) {
            return true;
          }else{
            return false;
          }
        },
        getAvailableClasses(){
          let results = [];
          for (var i = 0; i < this.graph.length; i++) {
            if (this.graph[i].hasOwnProperty('@type') && this.graph[i]['@type'] === "rdfs:Class") {
              results.push(this.graph[i]);
            }
          }
          this.availableClasses = results.sort();
        },
        handleChange: function(e){
          let target = e.target.value;
          this.filter = e.target.value;
          let fullList = this.availableClasses;
          let results = [];
          switch (target) {
            case 'ALL':
              this.filterResults = fullList;
              break;
            default:
              results = fullList;
              results = fullList.filter(word => word["rdfs:label"][0] === target);
              this.filterResults = results;
          }
        },
        getSubclass(data){
          if (data.hasOwnProperty("rdfs:subClassOf")) {
            this.subclass = data["rdfs:subClassOf"]['@id'].slice(7);
          }
        },
        getPropertyInfo(){
          let results =[];
          for (var i = 0; i < this.graph.length; i++) {
            //check if label is obj or array
            if (this.graph[i].hasOwnProperty("rdfs:label") && this.graph[i]["rdfs:label"].toString().toLowerCase() === this.query.toLowerCase()) {
              this.property = this.graph[i]["rdfs:label"];
              console.log('prop label found')
              console.log(this.graph[i]["rdfs:label"])
              this.propertyInfo = this.graph[i];
              results.push(this.graph[i])
            }
          }
          this.properties = results;
        }
			},
			mounted:function(){
        let context = {{Context}}
         if ( context.Content ) {
           console.log('Context Query = ',context.Query);
           this.query = context.Query.toLowerCase();
         }

			},
      created:function(){
          this.reqFile()
      }
		});


</script>
{% include "footer.html" %}
{% endblock %}
