{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<div id="viewer" class="container" style="min-height: 70vh;">
  <div class="row" style="margin-top:40px;">
    <div class="col-lg-2">
      <template v-if="availableClasses">
        <ul class="list-group">
          <li class="list-group-item bg-dark text-light">
            Available Classes
          </li>
          <li class="list-group-item" v-for="(item,i) in availableClasses">
            <a :href="'/viewer/'+item" v-text='item'></a>
          </li>
        </ul>
      </template>
    </div>
    <div class="col-sm-10">
      <div v-if="noResults" class="text-center jumbotron" style="margin-top:40px;">
        <h2 class="text-muted">No Results For That Item</h2>
        <p class="text-muted">
          Item my be out of scope or non-existent in the document
        </p>
      </div>
      <h1 class="text-dark" v-if='schemaClass' v-text='schemaClass'></h1>
      <h1 class="text-dark" v-if='property' v-text='property'></h1>
      <template v-if="subclass && schemaClass">
        <a :href="'/viewer/'+subclass" v-text="subclass"></a>
        >
        <a :href="'/viewer/'+schemaClass" v-text="schemaClass"></a>
      </template>
      <template v-if="schemaClass">
        <p v-html="classInfo['rdfs:comment']"></p>
      </template>
      <table class="table" v-if="properties.length" style="margin-bottom: 40px">
      <thead class="bg-dark text-light">
        <tr>
          <th scope="col">Property</th>
          <th scope="col">Expected Type</th>
          <th scope="col">Description</th>
        </tr>
      </thead>
      <tbody v-for="(item,i) in properties">
        <tr >
          <td>
            <span class="text-muted" v-if='schemaClass' v-html='schemaClass'></span><span v-if='schemaClass'>.</span><a class="font-weight-bold" :href='"/viewer/"+getTitle(item)' v-html=getTitle(item)></a></td>
          <td>
            <a style="display: block;" v-for="(type,i) in getType(item)" :href="'/viewer/'+type" v-html='type'></a>
          </td>
          <td v-html=getDescription(item)></td>
        </tr>
      </tbody>
    </table>
    <template v-if='property'>
      <ul class="list-group" style="max-width: 50vw;">
        <li class="list-group-item bg-dark text-light">
          Used on these types
        </li>
        <li v-if="!propertyInfo['schema:domainIncludes']['@id']" class="list-group-item" v-for="(item,i) in propertyInfo['schema:domainIncludes']">
          <a :href="'/viewer/'+item['@id'].slice(7)" v-text="item['@id'].slice(7)"></a>
        </li>
        <li v-else class="list-group-item" >
          <a :href="'/viewer/'+propertyInfo['schema:domainIncludes']['@id']" v-text="propertyInfo['schema:domainIncludes']['@id'].slice(7)"></a>
        </li>
      </ul>
    </template>
    </div>
  </div>
</div>

{% endblock %}
{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script src="/static/js/lodash.js"></script>
<script>
var app = new Vue({
      el: '#viewer',
			data: function(){
				return {
          graph: [],
          query:'',
          schemaClass:'',
          properties:[],
          property:'',
          propertyInfo:{},
          classes:[],
          noResults: false,
          subclass: '',
          classInfo:{},
          availableClasses:[],
				}
			},
			methods:{
        determinePath(){
          if (this.getClass()) {
            console.log('PATH: CLASS')
            this.getClassProperties()
          }else if (!this.getClass()){
            console.log('PATH: PROPERTY')
            this.getPropertyInfo()
          }
          if(!this.properties.length){
            this.noResults = true;
          }
        },
        getTitle: function(data){
          if (data.hasOwnProperty('rdfs:label')) {
            if (_.isObject(data['rdfs:label'])) {
              if (data['rdfs:label'].hasOwnProperty('@value')) {
                return data['rdfs:label']['@value']
              }else{
                return data['rdfs:label'];
              }
            }else if (_.isString(data['rdfs:label'])) {
              return data["rdfs:label"];
            }
          }else{
            //console.log(data)
            return 'no property name available'
          }
        },
        getType: function(data){
          let types=[];
          if (data.hasOwnProperty("schema:rangeIncludes")) {
            if (_.isArray(data["schema:rangeIncludes"])) {
              for (var i = 0; i < data['schema:rangeIncludes'].length; i++) {
                types.push(data['schema:rangeIncludes'][i]['@id'].slice(7));
              }
            }else if(_.isObject(data["schema:rangeIncludes"])){
              types.push(data['schema:rangeIncludes']['@id'].slice(7));
            }
          }
          return types;
        },
        getDescription: function(data){
          if (data.hasOwnProperty("rdfs:comment")) {
            return data["rdfs:comment"];
          }else{
            return 'no description available'
          }
        },
        reqFile: function(){
          axios.get('/static/misc/book.jsonld').then(res=>{
            // console.log('graph',res.data['@graph'])
            this.graph = res.data['@graph']
            this.determinePath()
            this.getAvailableClasses()
          }).catch(err=>{
            throw err;
          })
        },
        getClassProperties(){
            for (var i = 0; i < this.graph.length; i++) {
              if (this.graph[i].hasOwnProperty('schema:domainIncludes') && this.graph[i]["@type"] === "rdf:Property") {
                this.extractPropertyInfo(this.graph[i]);
              }
            }
        },
        extractPropertyInfo(data){
          if ( _.isArray(data['schema:domainIncludes']) ) {
            for (var i = 0; i < data['schema:domainIncludes'].length; i++) {
              if (data["schema:domainIncludes"][i]['@id'].toLowerCase() === 'schema:'+this.query || data["schema:domainIncludes"][i]['@id'].toLowerCase() === this.query) {
                this.properties.push(data);
              }
            }
          }else if( _.isObject(data['schema:domainIncludes']) ){
            if (data["schema:domainIncludes"]['@id'].toLowerCase() === 'schema:'+this.query || data["schema:domainIncludes"]['@id'].toLowerCase() === this.query ) {
              this.properties.push(data);
            }
          }
          this.properties = _.sortBy(this.properties, [user => user['rdfs:label']], ['asc']);
        },
        getClass(){
          let results = [];
          for (var i = 0; i < this.graph.length; i++) {
            if (this.graph[i].hasOwnProperty('@type') && this.graph[i]['@type'] === "rdfs:Class" && this.graph[i]["rdfs:label"].toLowerCase() === this.query) {
              //console.log('class found',this.graph[i]["rdfs:label"]);
              this.schemaClass = this.graph[i]["rdfs:label"];
              this.classInfo= this.graph[i];
              this.getSubclass(this.graph[i]);
            }
          }
          if (this.schemaClass) {
            return true;
          }else{
            return false;
          }
        },
        getAvailableClasses(){
          let results = [];
          for (var i = 0; i < this.graph.length; i++) {
            if (this.graph[i].hasOwnProperty('@type') && this.graph[i]['@type'] === "rdfs:Class") {
              results.push(this.graph[i]["rdfs:label"]);
            }
          }
          this.availableClasses = results;
        },
        getSubclass(data){
          if (data.hasOwnProperty("rdfs:subClassOf")) {
            this.subclass = data["rdfs:subClassOf"]['@id'].slice(7);
          }
        },
        getPropertyInfo(){
          let results =[];
          for (var i = 0; i < this.graph.length; i++) {
            if (this.graph[i].hasOwnProperty("rdfs:label") && this.graph[i]["rdfs:label"] === this.query.toLowerCase()) {
              //console.log('property found',this.graph[i]["rdfs:label"]);
              this.property = this.graph[i]["rdfs:label"];
              this.propertyInfo = this.graph[i];
              results.push(this.graph[i])
            }
          }
          this.properties = results;
        }
			},
			mounted:function(){
        let context = {{Context}}
         if ( context.Content ) {
           console.log('Context Query = ',context.Query);
           this.query = context.Query.toLowerCase();
         }

			},
      created:function(){
          this.reqFile()
      }
		});


</script>
{% include "footer.html" %}
{% endblock %}
